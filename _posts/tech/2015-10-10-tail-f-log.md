---
layout: post
title: 远程 tail 日志文件
category: 技术
tags: 日志
keywords: tail, log
description: 
---  


很多时候开发人员都会有查看服务器日志的需求，而且很多时候是在上线发布或者出现错误的时候， 大多数都会执行的命令如下：

		tail -f iam.log
		tail -f iam.log | grep Exception
		tail -1000 iam.log
		tail -1000 iam.log | grep Error
		balala ...
		
但是很多公司登陆服务器的步骤十分繁琐， 比如要先登陆到跳板机， 然后从跳板机才能登陆到相应的服务器。跳板机的登陆又有双因子验证之类， 比如结合某些手机上的验证码。 这种情况下想要查看日志会比较麻烦，特别是比较紧急的情况，登陆到服务器就得费一番周折。因此我们需要一种简单的查看日志的方式，比如不用登陆服务器就可以在本地执行 tail 命令，或者有 web 页面可以让我们查看相应的日志。基于这样的需求调研了几种方案，以下是一些方案的实现和优缺点介绍。

---
### 1. nc & http event stream 

		echo -e 'HTTP/1.1 200 OK\nAccess-Control-Allow-Origin: *\nContent-type: text/event-stream\n' && tail -f ./iam.log | sed -e 's/^/data: /;s/$/\\n/' | nc -l 1234
		
打开浏览器，输入 [http://127.0.0.1:1234/](http://127.0.0.1:1234/), 如果 iam.log 一直有内容在写入的话， 你就可以看到新的添加内容源源不断地显示在浏览器中了。那么这一行命令的原理是什么呢？这里我们首先需要了解 ``` nc ``` 命令和 HTTP中 ```Content-type: text/event-stream``` 。

>nc -  The nc (or netcat) utility is used for just about anything under the sun involving TCP or UDP.  It can open TCP connections, send UDP packets, listen on
     arbitrary TCP and UDP ports, do port scanning, and deal with both IPv4 and IPv6.  Unlike telnet(1), nc scripts nicely, and separates error messages onto
     standard error instead of sending them to standard output, as telnet(1) does with some.
     
简单来说 nc 是一款短小精悍的网络工具，可通过 TCP 或 UDP 协议传输读写数据。上面的命令将管道之前命令的输出通过 1234 端口发送出去，在发送的 TCP 数据的前面添加了 HTTP 协议相关的东西，所以这里可以等价与一个简单的 http 服务， 可以通过浏览器连接。在 HTTP 头中声明了 Content-type: text/event-stream。
 
 	
>	Server-Sent Events - One Way Messaging.<br>
 	A server-sent event is when a web page automatically gets updates from a server.
 	This was also possible before, but the web page would have to ask if any updates were available. With server-sent events, the updates come automatically.
 	
在 http 中设置了 Content-type: text/event-stream 之后， 则客户端会源源不断的从服务器端获取更新的数据。上面的命令采用了这种方式，相当于将 tail -f ./iam.log 的输出源源不断的发送到客户端， 就实现浏览器能够获取 tail 的内容。
但是这种方式的问题在于，这种方案是一次性的，就是只能接受一次连接请求，之后便会失效， 这个和 nc 的实现相关， 其只会等待第一次 TCP 连接， 并把数据发送给它。

---

### 2. Cherrypy & subprocess & http event stream



 
### 参考 
 [1] http://www.cnblogs.com/wenbiao/p/3375811.html
 
 [2] http://www.w3schools.com/html/html5_serversentevents.asp